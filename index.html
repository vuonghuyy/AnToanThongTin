<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Demo Mã Hóa (Client-Side)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px M15px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        textarea, input, select { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        textarea { resize: vertical; min-height: 80px; }
        .button-group { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; color: white; font-size: 16px; cursor: pointer; }
        #encryptBtn { background-color: #007bff; }
        #decryptBtn { background-color: #28a745; }
        #status { text-align: center; margin-top: 20px; font-size: 1.1em; font-weight: bold; min-height: 24px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Công Cụ Demo Mã Hóa (Chỉ dùng JS)</h2>

    <div class="form-group">
        <label for="algorithm">Thuật toán:</label>
        <select id="algorithm">
            <option value="AES-GCM">AES-GCM (Khuyên dùng)</option>
            <option value="Caesar">Mã dịch vòng (Caesar)</option>
            <option value="SHA-256">Băm SHA-256</option>
        </select>
    </div>

    <div class="form-group">
        <label for="plainText">Bản rõ (Plaintext):</label>
        <textarea id="plainText" placeholder="Nhập văn bản gốc..."></textarea>
    </div>

    <div class="form-group">
        <label for="key">Khóa (Mật khẩu):</label>
        <input type="text" id="key" placeholder="Nhập khóa/mật khẩu...">
    </div>

    <div class="form-group">
        <label for="cipherText">Bản mã (Ciphertext - Base64):</label>
        <textarea id="cipherText" placeholder="Kết quả mã hóa..."></textarea>
    </div>
    
    <div class="button-group">
        <button id="encryptBtn">Mã hóa (Encrypt)</button>
        <button id="decryptBtn">Giải mã (Decrypt)</button>
    </div>
    
    <div class="form-group">
        <label for="verificationText">Text kiểm tra (sau giải mã):</label>
        <textarea id="verificationText" readonly style="background-color: #e9ecef;"></textarea>
    </div>

    <div id="status">Chưa kiểm tra</div>
</div>

<script>
    // --- Lấy các phần tử DOM ---
    const algorithmSelect = document.getElementById('algorithm');
    const plainTextEl = document.getElementById('plainText');
    const keyEl = document.getElementById('key');
    const cipherTextEl = document.getElementById('cipherText');
    const verificationTextEl = document.getElementById('verificationText');
    const encryptBtn = document.getElementById('encryptBtn');
    const decryptBtn = document.getElementById('decryptBtn');
    const statusDiv = document.getElementById('status');
    const textEncoder = new TextEncoder();
    const textDecoder = new TextDecoder();

    // --- Các hàm tiện ích ---
    const bufferToBase64 = (buffer) => btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
    const base64ToBuffer = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const bufferToHex = (buffer) => Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');

    // --- Hàm xử lý chính ---

    async function getAesKey(password) {
        // Biến một mật khẩu bất kỳ thành một khóa AES 256-bit an toàn
        const keyData = textEncoder.encode(password);
        const keyHash = await crypto.subtle.digest('SHA-256', keyData);
        return await crypto.subtle.importKey('raw', keyHash, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
    }

    // Mã hóa Caesar bằng JS thuần
    function caesarCipher(text, key) {
        return text.split('').map(char => {
            if (char.match(/[a-z]/i)) {
                const code = char.charCodeAt(0);
                const base = code >= 65 && code <= 90 ? 65 : 97;
                return String.fromCharCode(((code - base + key) % 26) + base);
            }
            return char;
        }).join('');
    }

    // --- Gắn sự kiện ---
    encryptBtn.addEventListener('click', async () => {
        try {
            const plainText = plainTextEl.value;
            const key = keyEl.value;
            const algorithm = algorithmSelect.value;
            let cipherText = '';

            if (!plainText) { alert("Bản rõ không được để trống."); return; }
            if (algorithm !== 'SHA-256' && !key) { alert("Khóa không được để trống."); return; }

            switch (algorithm) {
                case 'AES-GCM':
                    const cryptoKey = await getAesKey(key);
                    const iv = crypto.getRandomValues(new Uint8Array(12)); // IV rất quan trọng cho AES-GCM
                    const encryptedBuffer = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        cryptoKey,
                        textEncoder.encode(plainText)
                    );
                    // Gắn IV vào trước bản mã để lúc giải mã có thể lấy ra
                    const combined = new Uint8Array(iv.length + encryptedBuffer.byteLength);
                    combined.set(iv);
                    combined.set(new Uint8Array(encryptedBuffer), iv.length);
                    cipherText = bufferToBase64(combined);
                    break;
                case 'Caesar':
                    cipherText = caesarCipher(plainText, parseInt(key, 10));
                    break;
                case 'SHA-256':
                    const hashedBuffer = await crypto.subtle.digest('SHA-256', textEncoder.encode(plainText));
                    cipherText = bufferToHex(hashedBuffer);
                    break;
            }
            cipherTextEl.value = cipherText;
            verificationTextEl.value = '';
            statusDiv.textContent = 'Đã mã hóa thành công!';
            statusDiv.style.color = 'blue';
        } catch (error) {
            alert("Lỗi mã hóa: " + error.message);
        }
    });

    decryptBtn.addEventListener('click', async () => {
        try {
            const cipherText = cipherTextEl.value;
            const key = keyEl.value;
            const algorithm = algorithmSelect.value;
            let decryptedText = '';
            
            if (!cipherText) { alert("Bản mã không được để trống."); return; }
            if (!key) { alert("Khóa không được để trống."); return; }

            switch (algorithm) {
                case 'AES-GCM':
                    const cryptoKey = await getAesKey(key);
                    const combinedBuffer = base64ToBuffer(cipherText);
                    const iv = combinedBuffer.slice(0, 12); // Lấy IV ra từ 12 byte đầu
                    const encryptedData = combinedBuffer.slice(12); // Phần còn lại là bản mã
                    const decryptedBuffer = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: iv },
                        cryptoKey,
                        encryptedData
                    );
                    decryptedText = textDecoder.decode(decryptedBuffer);
                    break;
                case 'Caesar':
                    decryptedText = caesarCipher(cipherText, -parseInt(key, 10));
                    break;
            }
            verificationTextEl.value = decryptedText;
            // So sánh
            if (plainTextEl.value === decryptedText) {
                statusDiv.textContent = 'TRÙNG KHỚP';
                statusDiv.style.color = 'green';
            } else {
                statusDiv.textContent = 'KHÔNG TRÙNG KHỚP';
                statusDiv.style.color = 'red';
            }
        } catch (error) {
            alert("Lỗi giải mã: " + error.message);
            statusDiv.textContent = 'GIẢI MÃ THẤT BẠI';
            statusDiv.style.color = 'red';
        }
    });
    
    algorithmSelect.addEventListener('change', () => {
        const isHashing = algorithmSelect.value === 'SHA-256';
        decryptBtn.disabled = isHashing;
        keyEl.disabled = isHashing;
        keyEl.placeholder = isHashing ? 'Không cần thiết' : 'Nhập khóa/mật khẩu...';
    });
    
    algorithmSelect.dispatchEvent(new Event('change'));

</script>
</body>
</html>